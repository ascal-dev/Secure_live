name: DEBUG Telegram Poster

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch APIs
        run: |
          curl -s "https://crictv.cricketstream745.workers.dev/?url=https://m.cricbuzz.com/api/home" > match.json
          curl -s "https://matcheslinks-eaa.pages.dev/alternate.json" > source1.json
          curl -s "https://allrounderfuvk.pages.dev/id.json" > source2.json

          echo "===== MATCH ====="
          cat match.json
          echo "===== SOURCE 1 ====="
          cat source1.json
          echo "===== SOURCE 2 ====="
          cat source2.json

      - name: Process & FORCE Post
        env:
          BOT: ${{ secrets.TG_BOT_TOKEN }}
          CHAT: ${{ secrets.TG_CHANNEL_ID }}
          SITE: ${{ secrets.SITE_URL }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const { execSync } = require("child_process");

          console.log("ENV CHECK:", {
            BOT: !!process.env.BOT,
            CHAT: process.env.CHAT,
            SITE: process.env.SITE
          });

          const matchData = JSON.parse(fs.readFileSync("match.json","utf8"));
          const source1 = JSON.parse(fs.readFileSync("source1.json","utf8"));
          const source2 = JSON.parse(fs.readFileSync("source2.json","utf8"));

          const match = matchData?.matches?.[0]?.match?.matchInfo;
          if (!match) {
            console.log("NO MATCH FOUND");
            process.exit(0);
          }

          console.log("MATCH FOUND:", match.seriesName);
          console.log("STATUS:", match.status);
          console.log("START:", new Date(match.startDate).toISOString());

          let msg =
            "ðŸ DEBUG POST\n" +
            match.seriesName + "\n" +
            match.team1.teamSName + " vs " + match.team2.teamSName + "\n\n";

          msg += "Source 1:\n";
          for (const g in source1) {
            for (const n in source1[g]) {
              msg += process.env.SITE + "/player/test/" + g + "\n";
            }
          }

          msg += "\nSource 2:\n";
          for (const i of (source2.iframes || [])) {
            msg += process.env.SITE + "/player/test/" + i.id + "\n";
          }

          console.log("FINAL MESSAGE:\n", msg);

          const res = execSync(
            'curl -v -X POST https://api.telegram.org/bot' +
            process.env.BOT +
            '/sendMessage ' +
            '-d chat_id=' + process.env.CHAT + ' ' +
            '-d text="' + msg.replace(/"/g, '\\"') + '"'
          ).toString();

          console.log("TELEGRAM RESPONSE:", res);
          EOF
