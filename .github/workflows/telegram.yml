name: Telegram Auto Poster (SAFE)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch APIs
        run: |
          curl -s "https://crictv.cricketstream745.workers.dev/?url=https://m.cricbuzz.com/api/home" > match.json
          curl -s "https://matcheslinks-eaa.pages.dev/alternate.json" > source1.json
          curl -s "https://allrounderfuvk.pages.dev/id.json" > source2.json

      - name: Send Telegram Messages
        env:
          BOT: ${{ secrets.TG_BOT_TOKEN }}
          CHAT: ${{ secrets.TG_CHANNEL_ID }}
          SITE: ${{ secrets.SITE_URL }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const { execSync } = require("child_process");

          function send(text) {
            execSync(
              'curl -s https://api.telegram.org/bot' +
              process.env.BOT +
              '/sendMessage -d chat_id=' +
              process.env.CHAT +
              ' -d disable_web_page_preview=true ' +
              ' -d text="' + text.replace(/"/g, '\\"') + '"'
            );
          }

          function sendChunks(title, links) {
            let msg = title + "\\n";
            for (const l of links) {
              if ((msg + l).length > 3500) {
                send(msg);
                msg = title + "\\n";
              }
              msg += l + "\\n";
            }
            if (msg.trim() !== title) send(msg);
          }

          const match = JSON.parse(fs.readFileSync("match.json","utf8"))
            ?.matches?.[0]?.match?.matchInfo;

          if (!match) {
            send("‚ö†Ô∏è No live/upcoming match found");
            process.exit(0);
          }

          send(
            "üèè " + match.seriesName + "\\n" +
            match.team1.teamSName + " vs " + match.team2.teamSName + "\\n\\n" +
            "‚è∞ " + match.status
          );

          const s1 = JSON.parse(fs.readFileSync("source1.json","utf8"));
          const s2 = JSON.parse(fs.readFileSync("source2.json","utf8"));

          const src1 = [];
          for (const g in s1) src1.push(process.env.SITE + "/player/t20wc/" + g);

          const src2 = [];
          for (const i of (s2.iframes || []))
            src2.push(process.env.SITE + "/player/t20wc/" + i.id);

          sendChunks("Source 1:", src1);
          sendChunks("Source 2:", src2);
          EOF
