name: Auto Match Telegram Poster (DEBUG)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch APIs
        run: |
          curl -s "https://crictv.cricketstream745.workers.dev/?url=https://m.cricbuzz.com/api/home" > match.json
          echo "=== MATCH JSON ==="
          cat match.json

      - name: Process & Post
        env:
          BOT: ${{ secrets.TG_BOT_TOKEN }}
          CHAT: ${{ secrets.TG_CHANNEL_ID }}
          SITE: ${{ secrets.SITE_URL }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const { execSync } = require("child_process");

          const data = JSON.parse(fs.readFileSync("match.json","utf8"));
          const match = data?.matches?.[0]?.match?.matchInfo;

          console.log("MATCH FOUND:", !!match);
          if (!match) process.exit(0);

          console.log("SERIES:", match.seriesName);
          console.log("STATUS:", match.status);
          console.log("START DATE:", match.startDate);
          console.log("NOW:", Date.now());

          const diff = (match.startDate - Date.now()) / 60000;
          console.log("MINUTES TO START:", diff);

          // TEMP: allow wider window for testing
          if (diff > 120 || diff < -10) {
            console.log("âŒ Time condition not met");
            process.exit(0);
          }

          const series = match.seriesName.toLowerCase();
          let event = null;
          if (series.includes("ipl")) event = "ipl";
          else if (series.includes("t20")) event = "t20wc";

          console.log("EVENT TYPE:", event);
          if (!event) process.exit(0);

          const msg =
            "ðŸ " + match.seriesName + "\n" +
            match.team1.teamSName + " vs " + match.team2.teamSName + "\n\n" +
            "â° " + match.status + "\n\n" +
            "â–¶ï¸ Watch Live:\n" +
            process.env.SITE + "/player/" + event + "/willowbycric\n" +
            process.env.SITE + "/player/" + event + "/tnt";

          console.log("SENDING MESSAGE:\n", msg);

          const res = execSync(
            'curl -s -X POST https://api.telegram.org/bot' +
            process.env.BOT +
            '/sendMessage ' +
            '-d chat_id=' + process.env.CHAT + ' ' +
            '-d text="' + msg + '"'
          ).toString();

          console.log("TELEGRAM RESPONSE:", res);
          EOF
